#include <stdio.h>
#include <stdlib.h>

typedef struct signatureBlockType {

    unsigned char cbmFileType;
    unsigned char firstTrack;
    unsigned char firstSector;
    unsigned char filename[16];
    unsigned char fileHeaderBlockTrack;
    unsigned char fileHeaderBlockSector;
    unsigned char geosFileStructureType;
    unsigned char geosFileType;
    unsigned char yearLastModified;
    unsigned char monthLastModified;
    unsigned char dayLastModified;
    unsigned char hourLastModified;
    unsigned char minuteLastModified;
    unsigned char fileSize[2];
    unsigned char fileSignature[28];
    unsigned char fill[196];
    
} SignatureBlock;

typedef struct geosFileInfoBlockType {

    unsigned char iconWidth;
    unsigned char iconHeight;
    unsigned char iconData[64];
    unsigned char c64FileType;
    unsigned char geosFileType;
    unsigned char geosStructureType;
    unsigned char fileStartAddress[2];
    unsigned char fileEndAddress[2];
    unsigned char initAddress[2];
    unsigned char filename[20];
    unsigned char parentDiskAuthorName[20];
    unsigned char parentApplication[20];
    unsigned char application[23];
    unsigned char getInfo[95];
    
} GEOSFileInfoBlock;

typedef struct recBlockDataType {

    unsigned char sectorCount;
    unsigned char lastSectorIdx;

} RecBlockData;

typedef struct recordBlockType {

    RecBlockData recBlockData[127];

} RecordBlock;


const char block1[255] = {
    0x83, 0x00, 0x00, 0x44, 0x45, 0x53, 0x4b, 0x20, 0x54, 0x4f, 0x50, 0xa0, 0xa0, 0xa0, 0xa0, 0xa0,
    0xa0, 0xa0, 0xa0, 0x00, 0x00, 0x01, 0x04, 0x58, 0x08, 0x13, 0x0d, 0x23, 0x78, 0x00, 0x50, 0x52,
    0x47, 0x20, 0x66, 0x6f, 0x72, 0x6d, 0x61, 0x74, 0x74, 0x65, 0x64, 0x20, 0x47, 0x45, 0x4f, 0x53,
    0x20, 0x66, 0x69, 0x6c, 0x65, 0x20, 0x56, 0x31, 0x2e, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

const char block2[255] = {
                                                                                        0x03, 0x15,
    0xbf, 0xff, 0xff, 0xff, 0x92, 0x49, 0x01, 0xff, 0xff, 0x01, 0x80, 0x00, 0x1d, 0xbf, 0xff, 0xdd,
    0xa0, 0x00, 0x5d, 0xbf, 0xff, 0xc1, 0xa0, 0x00, 0x5d, 0xa1, 0xc6, 0x55, 0xa0, 0x29, 0x5d, 0xa0,
    0xc9, 0x41, 0xa1, 0x09, 0x41, 0xb9, 0xd6, 0x41, 0xa8, 0x00, 0x41, 0xbf, 0xff, 0xc1, 0x80, 0x00,
    0x1d, 0x9c, 0x00, 0x15, 0x9c, 0x00, 0x15, 0x80, 0x00, 0x1d, 0x80, 0x00, 0x01, 0xff, 0xff, 0xff,
    0x83, 0x04, 0x01, 0x56, 0x19, 0x55, 0x19, 0x75, 0x51, 0x64, 0x65, 0x73, 0x6b, 0x54, 0x6f, 0x70,
    0x20, 0x41, 0x4d, 0x20, 0x20, 0x56, 0x32, 0x2e, 0x30, 0x00, 0x00, 0x00, 0x00, 0x42, 0x72, 0x69,
    0x61, 0x6e, 0x20, 0x44, 0x6f, 0x75, 0x67, 0x68, 0x65, 0x72, 0x74, 0x79, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x4c, 0x2a, 0x5b, 0x4c, 0x59, 0x5d, 0x4c, 0xa7, 0x61, 0x4c, 0x3a,
    0x62, 0xad, 0x8a, 0x84, 0xd0, 0x01, 0x60, 0x20, 0x7e, 0x23, 0x20, 0x9c, 0x55, 0x73, 0x65, 0x20,
    0x74, 0x68, 0x65, 0x20, 0x64, 0x65, 0x73, 0x6b, 0x54, 0x6f, 0x70, 0x20, 0x74, 0x6f, 0x20, 0x6d,
    0x61, 0x6e, 0x61, 0x67, 0x65, 0x20, 0x61, 0x6e, 0x64, 0x20, 0x6d, 0x61, 0x6e, 0x69, 0x70, 0x75,
    0x6c, 0x61, 0x74, 0x65, 0x20, 0x79, 0x6f, 0x75, 0x72, 0x20, 0x66, 0x69, 0x6c, 0x65, 0x73, 0x2e,
    0x00, 0x03, 0x20, 0xe3, 0x5c, 0x68, 0x85, 0xfb, 0x20, 0x4f, 0x61, 0x20, 0x13, 0x61, 0x20, 0x32,
    0x61, 0x20, 0xf2, 0x5c, 0xa9, 0x0c, 0x20, 0xcc, 0x49, 0xa9, 0x2e, 0x85, 0x13, 0xa9, 0xf9, 0x85,
    0x12, 0xa9, 0x2f, 0x85, 0x15, 0xa9, 0x01, 0x85, 0x14, 0xa9, 0x84, 0x85
};

const char block3[255] = {
                                                                            0x43, 0x42, 0x0a, 0x0c, 
    0x0b, 0xf5, 0x0a, 0x8d, 0x0b, 0xa2, 0x09, 0x71, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

void concatenateFiles(FILE *dest, const char *srcName) {
    // Open the source file for reading in binary mode
    FILE *srcFile = fopen(srcName, "rb");
    if (srcFile == NULL) {
        perror("Failed to open a source file");
        return;
    }

    // Get the file size
    fseek(srcFile, 0, SEEK_END);
    long fileSize = ftell(srcFile);
    fseek(srcFile, 0, SEEK_SET);

    // Read the entire file into a buffer
    unsigned char *buffer = (unsigned char*) malloc(fileSize);
    fread(buffer, 1, fileSize, srcFile);

    // Write the buffer to the destination file
    fwrite(buffer+2, 1, fileSize-2, dest);

    // Free the buffer and close the source file
    free(buffer);
    fclose(srcFile);
}

void copyAndPadCharArray(const char *src, char *dest, size_t length, unsigned char pad) {
    size_t i;
    // Copy the source to destination up to 'length'
    for (i = 0; i < length && src[i] != '\0'; ++i) {
        dest[i] = src[i];
    }

    // Pad the remaining space with 0xA0
    for (; i < length; ++i) {
        dest[i] = pad;
    }
}


void buildBlock1(SignatureBlock* signatureBlock) {

    signatureBlock->cbmFileType = 0x83;
    signatureBlock->firstTrack = 0x00;
    signatureBlock->firstSector = 0x00;

    copyAndPadCharArray("desk top", signatureBlock->filename, 16, 0xa0);

    signatureBlock->fileHeaderBlockTrack = 0x00;
    signatureBlock->fileHeaderBlockSector = 0x00;
    signatureBlock->geosFileStructureType = 0x01; // VLIR
    signatureBlock->geosFileType = 0x04;        // system
    signatureBlock->yearLastModified = 0x58;    // 1988
    signatureBlock->monthLastModified = 0x08;   // august
    signatureBlock->dayLastModified = 0x13;     // 19th
    signatureBlock->hourLastModified = 0x0d;    // 1:35pm
    signatureBlock->minuteLastModified = 0x23;
    signatureBlock->fileSize[0] = 0x78;         //120 blocks
    signatureBlock->fileSize[1] = 0x00;

    copyAndPadCharArray("PRG formatted GEOS file V1.0", signatureBlock->fileSignature, 28, 0x00);

    for(unsigned char x=0; x< 196; x++)
        signatureBlock->fill[x] = 0x00;

}

int main(void) {

    FILE *outFile = fopen("desktop.cvt", "wb");
    if (outFile == NULL) {
        perror("Failed to open the output file");
        return 1;
    }

    fwrite(block1, sizeof(unsigned char), 254, outFile);
    fwrite(block2, sizeof(unsigned char), 254, outFile);
    fwrite(block3, sizeof(unsigned char), 254, outFile);
    fclose(outFile);

    outFile = fopen("desktop.cvt", "ab");
    if (outFile == NULL) {
        perror("Failed to open the output file");
        return 1;
    }

    concatenateFiles(outFile, "record1");
    concatenateFiles(outFile, "record2");
    concatenateFiles(outFile, "record3");
    concatenateFiles(outFile, "record4");
    concatenateFiles(outFile, "record5");
    concatenateFiles(outFile, "record6");

     fclose(outFile);

    return 0;

}